<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PDP Editor</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f3f3f3; margin: 0; padding: 0; color: #222; }
    .container { max-width: 900px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); padding: 32px 40px 40px 40px; }
    .hero { display: flex; gap: 32px; align-items: flex-start; margin-bottom: 32px; }
    .hero-media img { border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.10); max-width: 120px; max-height: 120px; background: #eee; display: block; }
    .hero-details { flex: 1; }
    .app-title-input, .app-desc-input { width: 100%; border: none; border-bottom: 2px solid #0078d7; font-size: 2.2rem; font-weight: 600; margin: 0 0 8px 0; color: #0078d7; outline: none; background: transparent; resize: none; }
    .app-desc-input { font-size: 1.1rem; font-weight: 400; color: #444; margin-bottom: 16px; border-bottom: 1px solid #aaa; min-height: 40px; }
    .pricing-input { font-size: 1.1rem; color: #0078d7; font-weight: 600; border: none; background: transparent; outline: none; border-bottom: 1px solid #0078d7; margin-bottom: 16px; }
    .approve-btn { background: #0078d7; color: #fff; border: none; border-radius: 4px; padding: 12px 32px; font-size: 1.1rem; font-weight: 500; cursor: pointer; margin-top: 24px; float: right; transition: background 0.2s; }
    .approve-btn:hover { background: #005fa1; }
    .section { margin-bottom: 32px; }
    .section-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 10px; color: #222; border-left: 4px solid #0078d7; padding-left: 10px; }
    .editable-list { list-style: disc inside; margin: 0 0 0 16px; padding: 0; color: #333; }
    .editable-list li { margin-bottom: 6px; display: flex; align-items: center; }
    .editable-list input { flex: 1; border: none; border-bottom: 1px solid #aaa; background: transparent; font-size: 1rem; margin-right: 8px; outline: none; }
    .add-btn, .remove-btn { background: #eee; border: none; color: #0078d7; font-size: 1.1rem; cursor: pointer; border-radius: 3px; margin-left: 4px; padding: 2px 8px; transition: background 0.2s; }
    .add-btn:hover, .remove-btn:hover { background: #0078d7; color: #fff; }
    .meta-table { border-collapse: collapse; width: 100%; margin-top: 8px; }
    .meta-table th, .meta-table td { text-align: left; padding: 6px 10px; border-bottom: 1px solid #eee; font-size: 1rem; }
    .meta-table th { color: #666; font-weight: 500; width: 180px; }
    .meta-table input, .meta-table select { width: 100%; border: none; border-bottom: 1px solid #aaa; background: transparent; font-size: 1rem; outline: none; }
    .clear { clear: both; }
    textarea { font-family: inherit; }
    .media-grid { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 12px; }
    .media-thumb { position: relative; width: 120px; height: 70px; border-radius: 6px; overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,0.10); background: #eee; display: flex; align-items: center; justify-content: center; }
    .media-thumb img, .media-thumb video { width: 100%; height: 100%; object-fit: cover; }
    .media-label { position: absolute; bottom: 2px; left: 2px; background: rgba(0,0,0,0.6); color: #fff; font-size: 0.75rem; padding: 1px 4px; border-radius: 3px; pointer-events: none; }
  </style>
</head>
<body>
  <div class="container">
    <div class="hero">
      <div class="hero-media" id="icon"></div>
      <div class="hero-details">
        <div style="margin-bottom: 16px;">
          <label for="listingSelect" style="font-weight:600;">Language Listing:</label>
          <select id="listingSelect" onchange="switchListing(this.value)"></select>
          <button class="add-btn" onclick="addListing()">+ Add Listing</button>
          <button class="remove-btn" onclick="removeListing()" style="margin-left:8px;">Remove Listing</button>
        </div>
        <input id="title" class="app-title-input" placeholder="App title" />
        <textarea id="description" class="app-desc-input" placeholder="description"></textarea>
        <input id="pricing" class="pricing-input" placeholder="Pricing" />
        <button class="approve-btn" onclick="approve()">Approve & Save</button>
      </div>
    </div>
    <div class="clear"></div>

    <div class="section">
      <div class="section-title">Screenshots</div>
      <div id="screenshots" class="media-grid"></div>
      <input type="file" id="screenshotUpload" multiple accept="image/*" style="margin-bottom:16px;">
      <button class="add-btn" onclick="uploadScreenshots()">Upload Screenshots</button>
    </div>

    <div class="section">
      <div class="section-title">Promotional Art & Media</div>
      <div id="promoMedia" class="media-grid"></div>
    </div>

    <div class="section">
      <div class="section-title">features</div>
      <ul class="editable-list" id="features"></ul>
      <button class="add-btn" onclick="addListItem('features')">+ Add Feature</button>
    </div>

    <div class="section">
      <div class="section-title">Release Notes</div>
      <textarea id="releaseNotes" style="width:100%;min-height:60px;"></textarea>
    </div>

    <div class="section">
      <div class="section-title">Hardware Requirements</div>
      <ul class="editable-list" id="hardware"></ul>
      <button class="add-btn" onclick="addListItem('hardware')">+ Add Hardware</button>
    </div>

    <div class="section">
      <div class="section-title">Genres</div>
      <ul class="editable-list" id="genres"></ul>
      <button class="add-btn" onclick="addListItem('genres')">+ Add Genre</button>
    </div>

    <div class="section">
      <div class="section-title">App Details</div>
      <table class="meta-table">
        <tr>
          <th>Category</th>
          <td><input id="category" /></td>
        </tr>
        <tr>
          <th>Visibility</th>
          <td>
            <select id="visibility">
              <option value="Public">Public</option>
              <option value="Private">Private</option>
              <option value="Hidden">Hidden</option>
            </select>
          </td>
        </tr>
        <tr>
          <th>Publish Mode</th>
          <td>
            <select id="publishMode">
              <option value="Immediate">Immediate</option>
              <option value="Manual">Manual</option>
            </select>
          </td>
        </tr>
        <tr>
          <th>Publish Date</th>
          <td><input id="publishDate" type="date" /></td>
        </tr>
        <tr>
          <th>Trial Period</th>
          <td><input id="trial" /></td>
        </tr>
        <tr>
          <th>Backup Enabled</th>
          <td>
            <select id="backup">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </td>
        </tr>
        <tr>
          <th>External In-App Products</th>
          <td>
            <select id="inapp">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </td>
        </tr>
        <tr>
          <th>Accessibility Guidelines Met</th>
          <td>
            <select id="accessibility">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </td>
        </tr>
      </table>
    </div>
  </div>




<script>

const sessionId = new URLSearchParams(window.location.search).get('session');
if (!sessionId) {
  alert("Session ID is required in the URL (e.g. ?session=12345)");
  throw new Error("Session ID not provided");
}

let metadata = {};
let baseListing = {};
let genresArr = [];
let featuresArr = [];
let hardwareArr = [];
let serverScreenshotsArr = [];
let previewScreenshotsArr = [];
let promoArr = [];
let iconFile = null;
let iconDataUrl = null;
let mediaBase = '';
let allMediaFiles = [];
let currentListingKey = null;

// Media type helpers
const screenshotPrefixes = [
  "Screenshot", "MobileScreenshot", "XboxScreenshot", "SurfaceHubScreenshot", "HoloLensScreenshot"
];
const iconPrefixes = [
  "Icon", "SquareIcon358X358"
];
const promoPrefixes = [
  "PromotionalArt16x9", "PromotionalArtwork2400X1200", "StoreLogo9x16", "StoreLogoSquare",
  "PromotionalArtwork414X180", "XboxBrandedKeyArt", "XboxTitledHeroArt", "XboxFeaturedPromotionalArt",
  "BackgroundImage1000X800"
];
const trailerPrefix = "Trailer";

function getMediaType(originalname) {
  for (const prefix of screenshotPrefixes) if (originalname.startsWith(prefix)) return "screenshot";
  for (const prefix of iconPrefixes) if (originalname.startsWith(prefix)) return "icon";
  for (const prefix of promoPrefixes) if (originalname.startsWith(prefix)) return "promo";
  if (originalname.startsWith(trailerPrefix)) return "trailer";
  return "other";
}

function dataURLtoBlob(dataurl) {
  const arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
    bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
  for (let i = 0; i < n; i++) u8arr[i] = bstr.charCodeAt(i);
  return new Blob([u8arr], { type: mime });
}

async function loadServerScreenshots(sessionId, mediaFiles, mediaBase) {
  const screenshotFiles = mediaFiles.filter(f => getMediaType(f) === "screenshot");
  const fetches = screenshotFiles.map(originalname =>
    fetch(`${mediaBase.replace(/\/$/, '')}/${originalname}`)
      .then(res => res.json())
      .then(data => {
        if (data.files && data.files.length) {
          return {
            originalname: data.files[0].originalname,
            buffer: data.files[0].buffer,
            dataUrl: `data:image/png;base64,${data.files[0].buffer}`
          };
        }
        return null;
      })
  );
  const results = await Promise.all(fetches);
  return results.filter(Boolean);
}

async function loadIconDataUrl(mediaBase, iconFile) {
  if (!iconFile) return null;
  const iconRes = await fetch(`${mediaBase.replace(/\/$/, '')}/${iconFile}`);
  const iconData = await iconRes.json();
  if (iconData.files && iconData.files.length) {
    return `data:image/png;base64,${iconData.files[0].buffer}`;
  }
  return null;
}

function renderMediaGrid(containerId, arr, base, label) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  arr.forEach((file) => {
    const isDataUrl = typeof file === 'string' && file.startsWith('data:');
    const isFullUrl = typeof file === 'string' && file.startsWith('http');
    const ext = isDataUrl ? '' : (typeof file === 'string' ? file.split('.').pop().toLowerCase() : '');
    const wrap = document.createElement('div');
    wrap.className = 'media-thumb';
    let mediaElem;
    if (!isDataUrl && !isFullUrl && ['mp4', 'webm'].includes(ext)) {
      mediaElem = document.createElement('video');
      mediaElem.src = base + file;
      mediaElem.controls = true;
    } else {
      mediaElem = document.createElement('img');
      mediaElem.src = isDataUrl || isFullUrl ? file : (base + file);
    }
    wrap.appendChild(mediaElem);
    const lbl = document.createElement('span');
    lbl.className = 'media-label';
    lbl.innerText = label;
    wrap.appendChild(lbl);
    container.appendChild(wrap);
  });
}

function renderIcon(iconDataUrl) {
  const iconDiv = document.getElementById('icon');
  iconDiv.innerHTML = '';
  if (iconDataUrl) {
    const img = document.createElement('img');
    img.src = iconDataUrl;
    img.alt = 'App Icon';
    iconDiv.appendChild(img);
  } else {
    // default placeholder if no icon is set
    iconDiv.innerHTML = '<div style="width:120px;height:120px;background:#e0e0e0;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#aaa;font-size:1.2rem;">No Icon</div>';
  }
}


function uploadScreenshots() {
  const input = document.getElementById('screenshotUpload');
  if (!input.files.length) return;

  // Read all files as data URLs in parallel
  const fileReaders = Array.from(input.files).map(file => {
    return new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.readAsDataURL(file);
    });
  });

  Promise.all(fileReaders).then(results => {
    previewScreenshotsArr = results;
    renderMediaGrid('screenshots', [
      ...serverScreenshotsArr.map(f => f.dataUrl),
      ...previewScreenshotsArr
    ], '', "Screenshot");
  });
}

function renderList(type, arr) {
  const ul = document.getElementById(type);
  ul.innerHTML = '';
  arr.forEach((item, idx) => {
    const li = document.createElement('li');
    li.innerHTML = `<input value="${item}" onchange="updateListItem('${type}', ${idx}, this.value)" />
      <button class="remove-btn" onclick="removeListItem('${type}', ${idx})">&times;</button>`;
    ul.appendChild(li);
  });
}

function addListItem(type) {
  if (type === 'features') featuresArr.push('');
  if (type === 'hardware') hardwareArr.push('');
  if (type === 'genres') genresArr.push('');
  renderList(type, type === 'features' ? featuresArr : type === 'hardware' ? hardwareArr : genresArr);
}

function removeListItem(type, idx) {
  if (type === 'features') featuresArr.splice(idx, 1);
  if (type === 'hardware') hardwareArr.splice(idx, 1);
  if (type === 'genres') genresArr.splice(idx, 1);
  renderList(type, type === 'features' ? featuresArr : type === 'hardware' ? hardwareArr : genresArr);
}
function updateListItem(type, idx, value) {
  if (type === 'features') featuresArr[idx] = value;
  if (type === 'hardware') hardwareArr[idx] = value;
  if (type === 'genres') genresArr[idx] = value;
}
window.addListItem = addListItem;
window.removeListItem = removeListItem;
window.updateListItem = updateListItem;

function populateListingDropdown() {
  const select = document.getElementById('listingSelect');
  select.innerHTML = '';
  const keys = Object.keys(metadata.listings || {});
  keys.forEach(key => {
    const opt = document.createElement('option');
    opt.value = key;
    opt.textContent = key;
    select.appendChild(opt);
  });
  if (!currentListingKey || !keys.includes(currentListingKey)) {
    currentListingKey = keys[0];
  }
  select.value = currentListingKey;
}

function switchListing(key) {
  saveCurrentListing();
  currentListingKey = key;
  loadListing();
}

function saveCurrentListing() {
  if (!currentListingKey || !metadata.listings[currentListingKey]) return;
  const listing = metadata.listings[currentListingKey];
  listing.baseListing = {
    ...listing.baseListing,
    title: document.getElementById('title').value,
    description: document.getElementById('description').value,
    features: featuresArr.filter(f => f.trim()),
    releaseNotes: document.getElementById('releaseNotes').value,
    minimumHardware: hardwareArr.filter(h => h.trim())
  };
}

function loadListing() {
  if (!currentListingKey || !metadata.listings || !metadata.listings[currentListingKey]) {
    baseListing = {};
    document.getElementById('title').value = '';
    document.getElementById('description').value = '';
    featuresArr = [];
    renderList('features', featuresArr);
    document.getElementById('releaseNotes').value = '';
    hardwareArr = [];
    renderList('hardware', hardwareArr);
    return;
  }
  const listing = metadata.listings[currentListingKey];
  baseListing = listing.baseListing || {};
  document.getElementById('title').value = baseListing.title || '';
  document.getElementById('description').value = baseListing.description || '';
  featuresArr = baseListing.features ? [...baseListing.features] : [];
  renderList('features', featuresArr);
  document.getElementById('releaseNotes').value = baseListing.releaseNotes || '';
  hardwareArr = baseListing.minimumHardware ? [...baseListing.minimumHardware] : [];
  renderList('hardware', hardwareArr);
}

function addListing() {
  const lang = prompt("Enter new language code (e.g. 'fr', 'es', 'de'):");
  if (!lang) return;
  if (!metadata.listings) metadata.listings = {};
  if (metadata.listings[lang]) {
    alert("Listing already exists for this language.");
    return;
  }
  metadata.listings[lang] = {
    baseListing: {
      title: '',
      description: '',
      features: [],
      releaseNotes: '',
      minimumHardware: []
    },
    platformOverrides: {}
  };
  currentListingKey = lang;
  populateListingDropdown();
  loadListing();
}

function removeListing() {
  if (!currentListingKey) return;
  const keys = Object.keys(metadata.listings || {});
  if (keys.length <= 1) {
    alert("At least one listing must remain.");
    return;
  }
  if (!confirm(`Are you sure you want to remove the "${currentListingKey}" listing?`)) return;
  delete metadata.listings[currentListingKey];
  const newKeys = Object.keys(metadata.listings);
  currentListingKey = newKeys[0];
  populateListingDropdown();
  loadListing();
}

async function initialLoad() {
  const data = await fetch(`/session/${sessionId}`).then(res => res.json());
  metadata = data.metadata;
  populateListingDropdown();
  loadListing();
  document.getElementById('pricing').value = (metadata.pricing && metadata.pricing.priceId) || 'Free';
  mediaBase = data.mediaBase || `/media/${sessionId}/`;
  allMediaFiles = Array.isArray(data.mediaFiles) ? data.mediaFiles : [];
  serverScreenshotsArr = await loadServerScreenshots(sessionId, allMediaFiles, mediaBase);
  renderMediaGrid('screenshots', [
    ...serverScreenshotsArr.map(f => f.dataUrl),
    ...previewScreenshotsArr
  ], '', "Screenshot");
  promoArr = [];
  iconFile = null;
  for (const file of allMediaFiles) {
    const type = getMediaType(file);
    if (type === "promo") promoArr.push(file);
    else if (type === "icon" && !iconFile) iconFile = file;
  }
  renderMediaGrid('promoMedia', promoArr, mediaBase, "Promo");
  iconDataUrl = await loadIconDataUrl(mediaBase, iconFile);
  renderIcon(iconDataUrl);
  genresArr = (metadata.gamingOptions && metadata.gamingOptions[0] && metadata.gamingOptions[0].genres) ? [...metadata.gamingOptions[0].genres] : [];
  renderList('genres', genresArr);
  document.getElementById('category').value = metadata.applicationCategory || '';
  document.getElementById('visibility').value = metadata.visibility || '';
  document.getElementById('publishMode').value = metadata.targetPublishMode || '';
  document.getElementById('publishDate').value = metadata.targetPublishDate ? metadata.targetPublishDate.split('T')[0] : '';
  document.getElementById('trial').value = (metadata.pricing && metadata.pricing.trialPeriod) || '';
  document.getElementById('backup').value = metadata.automaticBackupEnabled ? 'true' : 'false';
  document.getElementById('inapp').value = metadata.hasExternalInAppProducts ? 'true' : 'false';
  document.getElementById('accessibility').value = metadata.meetAccessibilityGuidelines ? 'true' : 'false';
}

function saveNonListingMetadata() {
  metadata.pricing = metadata.pricing || {};
  metadata.pricing.priceId = document.getElementById('pricing').value;
  metadata.applicationCategory = document.getElementById('category').value;
  metadata.visibility = document.getElementById('visibility').value;
  metadata.targetPublishMode = document.getElementById('publishMode').value;
  metadata.targetPublishDate = document.getElementById('publishDate').value;
  metadata.pricing.trialPeriod = document.getElementById('trial').value;
  metadata.automaticBackupEnabled = document.getElementById('backup').value === 'true';
  metadata.hasExternalInAppProducts = document.getElementById('inapp').value === 'true';
  metadata.meetAccessibilityGuidelines = document.getElementById('accessibility').value === 'true';
}

function getLocaleFromFilename(filename) {
  // Matches {Type}_{locale}_rest.ext or {Type}_all_rest.ext
  const match = filename.match(/^[^_]+_([a-zA-Z\-]+)_/);
  return match ? match[1] : null;
}

function handleMediaUploads(input, formData, allLocales, currentLocale,typePrefix = 'Screenshot') {
  if (!input || !input.files.length) return;
  Array.from(input.files).forEach(file => {
    let locale = currentLocale;
    let baseName = file.name.replace(/^[^_]+_[a-zA-Z\-]+_/, '');
    const newName = `${typePrefix}_${locale}_${baseName}`;
    formData.append('files', file, newName);
  });
}

async function approve() {
  saveCurrentListing();
  saveNonListingMetadata();
  const formData = new FormData();
  formData.append('metadata', JSON.stringify(metadata));
  const allLocales = Object.keys(metadata.listings || {});
  const currentLocale = currentListingKey || 'en';

  // Screenshots
  const screenshotInput = document.getElementById('screenshotUpload');
  handleMediaUploads(screenshotInput, formData, allLocales, currentLocale,"Screenshot");

  // Icon upload (if you have an icon file input)
  const iconInput = document.getElementById('iconUpload');
  handleMediaUploads(iconInput, formData, allLocales, currentLocale,"Icon");

  // Add similar lines for other media inputs if needed

  await fetch(`/${sessionId}/complete`, {
    method: 'POST',
    body: formData
  }).then(res => res.json());
  previewScreenshotsArr = [];
  await initialLoad();
  alert("Saved and Approved!");
}

document.addEventListener('DOMContentLoaded', async () => {
  await initialLoad();
});
</script>




</body>
</html>